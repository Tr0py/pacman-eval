remove /mnt/pmem0/log_kvs
#! /bin/bash -e

if [[ $(basename $PWD) != "scripts" ]]; then
  echo 'run this script in "scripts"'
  exit
fi

help() {
  echo "Usage: $0 <db_type> <apply_pacman>"
  echo "  <db_type>: 1: FlatStore-H, 2: FlatStore-PH, 3: FlatStore-FF, 4: FlatStore-M, 5: Viper, 6: ChameleonDB 7: PMem-RocksDB 8: pmemkv"
  echo "  <apply_pacman>: 0: false, 1: true (not affects PMem-RocksDB and pmemkv)"
}

if [[ $# == 1 ]]; then
  if [[ $1 > 0 && $1 < 6 ]]; then
    help
    exit
  fi
elif [[ $# != 2 || $1 < 1 || $1 > 8 || ($2 != 0 && $2 != 1) ]]; then
  help
  exit
fi

# to avoid no available space
sudo chown -R $USER /mnt/pmem0/
./clean_pmem_dir.sh

cat ./eval_etc.sh

INDEX_TYPE=1
if [[ $1 == 1 || $1 == 2 || $1 == 5 ]]; then
  INDEX_TYPE=1
elif [[ $1 == 3 ]]; then
  INDEX_TYPE=2
elif [[ $1 == 4 ]]; then
  INDEX_TYPE=3
fi

if [[ $1 == 1 || $1 == 4 || $1 == 5 ]]; then
  IDX_PERSISTENT="-DIDX_PERSISTENT=OFF"
else
  IDX_PERSISTENT="-DIDX_PERSISTENT=ON"
fi

if [[ $1 -le 4 ]]; then
  TARGET="pacman_bench"
  TARGET_CMD="./benchmarks/pacman_bench"
else
  WITH_OTHERS="-DEVAL_OTHER_SYSTEMS=ON"
  if [[ $1 == 5 ]]; then
    TARGET="viper_bench"
  elif [[ $1 == 6 ]]; then
    TARGET="chameleondb_bench"
  elif [[ $1 == 7 ]]; then
    TARGET="pmem_rocksdb_bench"
  elif [[ $1 == 8 ]]; then
    TARGET="pmemkv_bench"
  fi
    TARGET_CMD="./benchmarks/other/${TARGET}"
fi

PACMAN_OPT=""
if [[ $2 == 1 ]]; then
  PACMAN_OPT="-DPACMAN=ON"
fi

NUMA_AFFINITY=0
LOG_BATCHING=OFF # simulate FlatStore's batching (if LOG_PERSISTENT), diabled for fair comparison
#NUM_KEYS=200000000
NUM_KEYS=20000000
#NUM_OPS_PER_THREAD=200000000
#NUM_OPS_PER_THREAD=10000000000
#NUM_OPS_PER_THREAD=2000000000
NUM_OPS_PER_THREAD=1000000000
NUM_WARMUP_OPS_PER_THREAD=0
ETC_50_50=ON
FIRST_TOUCH=OFF

mkdir -p ../results
mkdir -p ../build
sudo chown $USER -R ../build
cd ../build

#THREADS=24
# If using RDRAM to emulate PMEM, use less threads to reduce bandwidth
# difference
THREADS=4
CAPACITY_RATIO=50
if [[ $1 -le 6 ]]; then
  FILTER="--benchmark_filter=/(${CAPACITY_RATIO})/.*/threads:(${THREADS})$"
  OUTPUT_FILE=../results/etc_$1_$2
else
  FILTER="--benchmark_filter=/.*/threads:(${THREADS})$"
  OUTPUT_FILE=../results/etc_$1
fi
# clean the result file

# it may take long to get third-party dependencies, so don't delete _deps
ls | grep -v _deps | xargs rm -rf
# build
cmake -DCMAKE_BUILD_TYPE=Release -DUSE_NUMA_NODE=${NUMA_AFFINITY} \
  ${WITH_OTHERS} -DINDEX_TYPE=${INDEX_TYPE} ${IDX_PERSISTENT} \
  -DLOG_BATCHING=${LOG_BATCHING} ${PACMAN_OPT} \
  -DNUM_KEYS=${NUM_KEYS} -DNUM_OPS_PER_THREAD=${NUM_OPS_PER_THREAD} \
  -DNUM_WARMUP_OPS_PER_THREAD=${NUM_WARMUP_OPS_PER_THREAD} \
  -DNUM_GC_THREADS=2 -DWORKLOAD_TYPE=ETC -DMEASURE_LATENCY=ON \
  -DETC_50_50=${ETC_50_50} -DFIRST_TOUCH=${FIRST_TOUCH} ..
make ${TARGET} -j

# disable cpu scaling
sudo cpupower frequency-set --governor performance > /dev/null
# clean cache
sudo sh -c "echo 3 > /proc/sys/vm/drop_caches"

#numactl --cpunodebind=${NUMA_AFFINITY} \
#  ${TARGET_CMD} --benchmark_repetitions=1 ${FILTER} \
#  --benchmark_out=${OUTPUT_FILE} --benchmark_out_format=json

${EXTRA_CMD} ${TARGET_CMD} --benchmark_repetitions=1 ${FILTER} \
	--benchmark_out=${OUTPUT_FILE} --benchmark_out_format=json

#sudo cpupower frequency-set --governor powersave > /dev/null
-- The C compiler identification is GNU 9.4.0
-- The CXX compiler identification is GNU 9.4.0
-- Check for working C compiler: /usr/bin/cc
-- Check for working C compiler: /usr/bin/cc -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Detecting C compile features
-- Detecting C compile features - done
-- Check for working CXX compiler: /usr/bin/c++
-- Check for working CXX compiler: /usr/bin/c++ -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- SET USE_NUMA_NODE 0
-- SET INDEX_TYPE 1
-- SET IDX_PERSISTENT ON
-- SET LOG_PERSISTENT ON
-- SET REDUCE_PM_ACCESS ON
-- SET HOT_COLD_SEPARATE ON
-- SET GC_SHORTCUT ON
-- SET BATCH_COMPACTION ON
-- SET ETC_50_50 ON
-- SET FIRST_TOUCH OFF
-- Will build and evaluate other systems
-- Setting build type to 'Release'
CMake Warning at benchmarks/CMakeLists.txt:2 (find_package):
  By not providing "Findbenchmark.cmake" in CMAKE_MODULE_PATH this project
  has asked CMake to find a package configuration file provided by
  "benchmark", but CMake did not find one.

  Could not find a package configuration file provided by "benchmark" with
  any of the following names:

    benchmarkConfig.cmake
    benchmark-config.cmake

  Add the installation prefix of "benchmark" to CMAKE_PREFIX_PATH or set
  "benchmark_DIR" to a directory containing one of the above files.  If
  "benchmark" provides a separate development package or SDK, be sure it has
  been installed.


-- Failed to find LLVM FileCheck
-- Found Git: /usr/bin/git (found version "2.25.1") 
-- git version: v1.6.0 normalized to 1.6.0
-- Version: 1.6.0
-- Performing Test HAVE_CXX_FLAG_STD_CXX11
-- Performing Test HAVE_CXX_FLAG_STD_CXX11 - Success
-- Performing Test HAVE_CXX_FLAG_WALL
-- Performing Test HAVE_CXX_FLAG_WALL - Success
-- Performing Test HAVE_CXX_FLAG_WEXTRA
-- Performing Test HAVE_CXX_FLAG_WEXTRA - Success
-- Performing Test HAVE_CXX_FLAG_WSHADOW
-- Performing Test HAVE_CXX_FLAG_WSHADOW - Success
-- Performing Test HAVE_CXX_FLAG_WERROR
-- Performing Test HAVE_CXX_FLAG_WERROR - Success
-- Performing Test HAVE_CXX_FLAG_WSUGGEST_OVERRIDE
-- Performing Test HAVE_CXX_FLAG_WSUGGEST_OVERRIDE - Success
-- Performing Test HAVE_CXX_FLAG_PEDANTIC
-- Performing Test HAVE_CXX_FLAG_PEDANTIC - Success
-- Performing Test HAVE_CXX_FLAG_PEDANTIC_ERRORS
-- Performing Test HAVE_CXX_FLAG_PEDANTIC_ERRORS - Success
-- Performing Test HAVE_CXX_FLAG_WSHORTEN_64_TO_32
-- Performing Test HAVE_CXX_FLAG_WSHORTEN_64_TO_32 - Failed
-- Performing Test HAVE_CXX_FLAG_FSTRICT_ALIASING
-- Performing Test HAVE_CXX_FLAG_FSTRICT_ALIASING - Success
-- Performing Test HAVE_CXX_FLAG_WNO_DEPRECATED_DECLARATIONS
-- Performing Test HAVE_CXX_FLAG_WNO_DEPRECATED_DECLARATIONS - Success
-- Performing Test HAVE_CXX_FLAG_WNO_DEPRECATED
-- Performing Test HAVE_CXX_FLAG_WNO_DEPRECATED - Success
-- Performing Test HAVE_CXX_FLAG_WSTRICT_ALIASING
-- Performing Test HAVE_CXX_FLAG_WSTRICT_ALIASING - Success
-- Performing Test HAVE_CXX_FLAG_WD654
-- Performing Test HAVE_CXX_FLAG_WD654 - Failed
-- Performing Test HAVE_CXX_FLAG_WTHREAD_SAFETY
-- Performing Test HAVE_CXX_FLAG_WTHREAD_SAFETY - Failed
-- Performing Test HAVE_CXX_FLAG_COVERAGE
-- Performing Test HAVE_CXX_FLAG_COVERAGE - Success
-- Performing Test HAVE_STD_REGEX
-- Performing Test HAVE_STD_REGEX
-- Performing Test HAVE_STD_REGEX -- success
-- Performing Test HAVE_GNU_POSIX_REGEX
-- Performing Test HAVE_GNU_POSIX_REGEX
-- Performing Test HAVE_GNU_POSIX_REGEX -- failed to compile
-- Performing Test HAVE_POSIX_REGEX
-- Performing Test HAVE_POSIX_REGEX
-- Performing Test HAVE_POSIX_REGEX -- success
-- Performing Test HAVE_STEADY_CLOCK
-- Performing Test HAVE_STEADY_CLOCK
-- Performing Test HAVE_STEADY_CLOCK -- success
-- Looking for pthread.h
-- Looking for pthread.h - found
-- Performing Test CMAKE_HAVE_LIBC_PTHREAD
-- Performing Test CMAKE_HAVE_LIBC_PTHREAD - Failed
-- Check if compiler accepts -pthread
-- Check if compiler accepts -pthread - yes
-- Found Threads: TRUE  
-- CMAKE_BUILD_TYPE: Release
-- TEST_DIR set to: "/home/ziyi/git/vpm-eval/deps/pacman/build/_deps/pmemkv-build/test"
-- CMAP engine is ON
-- CSMAP engine is OFF
-- VCMAP engine is ON
-- VSMAP engine is ON
-- STREE engine is ON
-- TREE3 engine is OFF
-- RADIX engine is OFF
-- ROBINHOOD engine is OFF
-- DRAM_VCMAP engine is OFF
-- Performing Test C_HAS__Wall
-- Performing Test C_HAS__Wall - Success
-- Performing Test CXX_HAS__Wall
-- Performing Test CXX_HAS__Wall - Success
-- Performing Test C_HAS__Wpointer_arith
-- Performing Test C_HAS__Wpointer_arith - Success
-- Performing Test CXX_HAS__Wpointer_arith
-- Performing Test CXX_HAS__Wpointer_arith - Success
-- Performing Test C_HAS__Wsign_compare
-- Performing Test C_HAS__Wsign_compare - Success
-- Performing Test CXX_HAS__Wsign_compare
-- Performing Test CXX_HAS__Wsign_compare - Success
-- Performing Test C_HAS__Wunreachable_code_return
-- Performing Test C_HAS__Wunreachable_code_return - Failed
-- Performing Test CXX_HAS__Wunreachable_code_return
-- Performing Test CXX_HAS__Wunreachable_code_return - Failed
-- Performing Test C_HAS__Wmissing_variable_declarations
-- Performing Test C_HAS__Wmissing_variable_declarations - Failed
-- Performing Test CXX_HAS__Wmissing_variable_declarations
-- Performing Test CXX_HAS__Wmissing_variable_declarations - Failed
-- Performing Test C_HAS__fno_common
-- Performing Test C_HAS__fno_common - Success
-- Performing Test CXX_HAS__fno_common
-- Performing Test CXX_HAS__fno_common - Success
-- Performing Test C_HAS__Wunused_macros
-- Performing Test C_HAS__Wunused_macros - Success
-- Performing Test CXX_HAS__Wunused_macros
-- Performing Test CXX_HAS__Wunused_macros - Success
-- Performing Test C_HAS__Wsign_conversion
-- Performing Test C_HAS__Wsign_conversion - Success
-- Performing Test CXX_HAS__Wsign_conversion
-- Performing Test CXX_HAS__Wsign_conversion - Success
-- Performing Test C_HAS__Wno_maybe_uninitialized
-- Performing Test C_HAS__Wno_maybe_uninitialized - Success
-- Performing Test CXX_HAS__Wno_maybe_uninitialized
-- Performing Test CXX_HAS__Wno_maybe_uninitialized - Success
-- Performing Test C_HAS__ggdb
-- Performing Test C_HAS__ggdb - Success
-- Performing Test CXX_HAS__ggdb
-- Performing Test CXX_HAS__ggdb - Success
-- Performing Test C_HAS__DDEBUG
-- Performing Test C_HAS__DDEBUG - Success
-- Performing Test CXX_HAS__DDEBUG
-- Performing Test CXX_HAS__DDEBUG - Success
-- Performing Test C_HAS__U_FORTIFY_SOURCE__D_FORTIFY_SOURCE_2
-- Performing Test C_HAS__U_FORTIFY_SOURCE__D_FORTIFY_SOURCE_2 - Success
-- Performing Test CXX_HAS__U_FORTIFY_SOURCE__D_FORTIFY_SOURCE_2
-- Performing Test CXX_HAS__U_FORTIFY_SOURCE__D_FORTIFY_SOURCE_2 - Success
-- Found Perl: /usr/bin/perl (found version "5.30.0") 
-- Checking for module 'libpmemobj++>=1.13.0'
--   Found libpmemobj++, version 1.13.0-git127.g9c8f5c78
-- Checking for module 'memkind>=1.8.0'
--   Found memkind, version 1.14.0+dev65+gc425635f
-- Performing Test LIBMEMKIND_NAMESPACE_PRESENT
-- Performing Test LIBMEMKIND_NAMESPACE_PRESENT - Success
-- Checking for module 'tbb'
--   Found in dir '/usr/lib/x86_64-linux-gnu' using pkg-config (ver: )
-- Performing Test C_HAS__Wno_unused_but_set_variable
-- Performing Test C_HAS__Wno_unused_but_set_variable - Success
-- Performing Test CXX_HAS__Wno_unused_but_set_variable
-- Performing Test CXX_HAS__Wno_unused_but_set_variable - Success
-- Some examples use csmap engine, which is disabled, hence they are not built. If you want to build them use -DENGINE_CSMAP=ON option.
-- Some examples use radix engine, which is disabled, hence they are not built. If you want to build them use -DENGINE_RADIX=ON option.
-- Found pandoc: /usr/bin/pandoc
-- Found Doxygen: /usr/bin/doxygen (found version "1.8.17") found components: doxygen dot 
-- Submodule update
-- Configuring done
-- Generating done
-- Build files have been written to: /home/ziyi/git/vpm-eval/deps/pacman/build
Scanning dependencies of target cceh
[ 62%] Built target benchmark
[ 65%] Building CXX object CMakeFiles/cceh.dir/db/index/CCEH/CCEH_MSB.cpp.o
In file included from /home/ziyi/git/vpm-eval/deps/pacman/include/db_common.h:10,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/index/CCEH/pair.h:5,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/index/CCEH/CCEH.h:3,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/index/CCEH/CCEH_MSB.cpp:1:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h: In member function ‘virtual void MMAPAllocator::Initialize()’:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h:179:31: warning: format ‘%p’ expects argument of type ‘void*’, but argument 2 has type ‘size_t’ {aka ‘long unsigned int’} [-Wformat=]
  179 |     printf("idx_pool_size_ = %p, is aligned to 2MB = %d\n", idx_pool_size_, (idx_pool_size_ & (2 * 1024 * 1024 - 1)) == 0);
      |                              ~^                             ~~~~~~~~~~~~~~
      |                               |                             |
      |                               void*                         size_t {aka long unsigned int}
      |                              %ld
[ 68%] Linking CXX static library libcceh.a
[ 68%] Built target cceh
Scanning dependencies of target pacman_bench
[ 72%] Building CXX object benchmarks/CMakeFiles/pacman_bench.dir/benchmark.cpp.o
[ 75%] Building CXX object benchmarks/CMakeFiles/pacman_bench.dir/histogram.cpp.o
[ 79%] Building CXX object benchmarks/CMakeFiles/pacman_bench.dir/__/db/log_structured.cpp.o
[ 82%] Building CXX object benchmarks/CMakeFiles/pacman_bench.dir/__/db/db.cpp.o
[ 86%] Building CXX object benchmarks/CMakeFiles/pacman_bench.dir/__/db/hotkeyset.cpp.o
[ 93%] Building CXX object benchmarks/CMakeFiles/pacman_bench.dir/__/db/log_cleaner.cpp.o
[ 93%] Building CXX object benchmarks/CMakeFiles/pacman_bench.dir/__/db/recovery.cpp.o
[ 96%] Building CXX object benchmarks/CMakeFiles/pacman_bench.dir/__/util/index_arena.cpp.o
In file included from /home/ziyi/git/vpm-eval/deps/pacman/benchmarks/benchmark.cpp:1:
/home/ziyi/git/vpm-eval/deps/pacman/benchmarks/bench_base.h:303:2: warning: #warning "ETC_50_50" [-Wcpp]
  303 | #warning "ETC_50_50"
      |  ^~~~~~~
In file included from /home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.cpp:1:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h: In member function ‘virtual void MMAPAllocator::Initialize()’:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h:179:31: warning: format ‘%p’ expects argument of type ‘void*’, but argument 2 has type ‘size_t’ {aka ‘long unsigned int’} [-Wformat=]
  179 |     printf("idx_pool_size_ = %p, is aligned to 2MB = %d\n", idx_pool_size_, (idx_pool_size_ & (2 * 1024 * 1024 - 1)) == 0);
      |                              ~^                             ~~~~~~~~~~~~~~
      |                               |                             |
      |                               void*                         size_t {aka long unsigned int}
      |                              %ld
In file included from /home/ziyi/git/vpm-eval/deps/pacman/include/db_common.h:10,
                 from /home/ziyi/git/vpm-eval/deps/pacman/include/db.h:11,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/log_cleaner.h:7,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/recovery.cpp:2:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h: In member function ‘virtual void MMAPAllocator::Initialize()’:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h:179:31: warning: format ‘%p’ expects argument of type ‘void*’, but argument 2 has type ‘size_t’ {aka ‘long unsigned int’} [-Wformat=]
  179 |     printf("idx_pool_size_ = %p, is aligned to 2MB = %d\n", idx_pool_size_, (idx_pool_size_ & (2 * 1024 * 1024 - 1)) == 0);
      |                              ~^                             ~~~~~~~~~~~~~~
      |                               |                             |
      |                               void*                         size_t {aka long unsigned int}
      |                              %ld
In file included from /home/ziyi/git/vpm-eval/deps/pacman/include/db_common.h:10,
                 from /home/ziyi/git/vpm-eval/deps/pacman/include/db.h:11,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/db.cpp:1:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h: In member function ‘virtual void MMAPAllocator::Initialize()’:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h:179:31: warning: format ‘%p’ expects argument of type ‘void*’, but argument 2 has type ‘size_t’ {aka ‘long unsigned int’} [-Wformat=]
  179 |     printf("idx_pool_size_ = %p, is aligned to 2MB = %d\n", idx_pool_size_, (idx_pool_size_ & (2 * 1024 * 1024 - 1)) == 0);
      |                              ~^                             ~~~~~~~~~~~~~~
      |                               |                             |
      |                               void*                         size_t {aka long unsigned int}
      |                              %ld
In file included from /home/ziyi/git/vpm-eval/deps/pacman/include/db_common.h:10,
                 from /home/ziyi/git/vpm-eval/deps/pacman/include/db.h:11,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/log_cleaner.h:7,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/log_cleaner.cpp:6:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h: In member function ‘virtual void MMAPAllocator::Initialize()’:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h:179:31: warning: format ‘%p’ expects argument of type ‘void*’, but argument 2 has type ‘size_t’ {aka ‘long unsigned int’} [-Wformat=]
  179 |     printf("idx_pool_size_ = %p, is aligned to 2MB = %d\n", idx_pool_size_, (idx_pool_size_ & (2 * 1024 * 1024 - 1)) == 0);
      |                              ~^                             ~~~~~~~~~~~~~~
      |                               |                             |
      |                               void*                         size_t {aka long unsigned int}
      |                              %ld
In file included from /home/ziyi/git/vpm-eval/deps/pacman/include/db_common.h:10,
                 from /home/ziyi/git/vpm-eval/deps/pacman/include/db.h:11,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/hotkeyset.cpp:2:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h: In member function ‘virtual void MMAPAllocator::Initialize()’:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h:179:31: warning: format ‘%p’ expects argument of type ‘void*’, but argument 2 has type ‘size_t’ {aka ‘long unsigned int’} [-Wformat=]
  179 |     printf("idx_pool_size_ = %p, is aligned to 2MB = %d\n", idx_pool_size_, (idx_pool_size_ & (2 * 1024 * 1024 - 1)) == 0);
      |                              ~^                             ~~~~~~~~~~~~~~
      |                               |                             |
      |                               void*                         size_t {aka long unsigned int}
      |                              %ld
In file included from /home/ziyi/git/vpm-eval/deps/pacman/include/db_common.h:10,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/segment.h:8,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/log_structured.h:13,
                 from /home/ziyi/git/vpm-eval/deps/pacman/db/log_structured.cpp:9:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h: In member function ‘virtual void MMAPAllocator::Initialize()’:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h:179:31: warning: format ‘%p’ expects argument of type ‘void*’, but argument 2 has type ‘size_t’ {aka ‘long unsigned int’} [-Wformat=]
  179 |     printf("idx_pool_size_ = %p, is aligned to 2MB = %d\n", idx_pool_size_, (idx_pool_size_ & (2 * 1024 * 1024 - 1)) == 0);
      |                              ~^                             ~~~~~~~~~~~~~~
      |                               |                             |
      |                               void*                         size_t {aka long unsigned int}
      |                              %ld
/home/ziyi/git/vpm-eval/deps/pacman/db/log_structured.cpp: In constructor ‘LogStructured::LogStructured(std::string, size_t, DB*, int, int)’:
/home/ziyi/git/vpm-eval/deps/pacman/db/log_structured.cpp:40:30: warning: format ‘%p’ expects argument of type ‘void*’, but argument 2 has type ‘size_t’ {aka ‘long unsigned int’} [-Wformat=]
   40 |     printf("total_log_size_ %p, is aligned to 2M? %d\n", total_log_size_, (total_log_size_ & (2 * 1024 * 1024 - 1)) == 0);
      |                             ~^                           ~~~~~~~~~~~~~~~
      |                              |                           |
      |                              void*                       size_t {aka long unsigned int}
      |                             %ld
In file included from /home/ziyi/git/vpm-eval/deps/pacman/include/db_common.h:10,
                 from /home/ziyi/git/vpm-eval/deps/pacman/include/db.h:11,
                 from /home/ziyi/git/vpm-eval/deps/pacman/benchmarks/benchmark.cpp:2:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h: In member function ‘virtual void MMAPAllocator::Initialize()’:
/home/ziyi/git/vpm-eval/deps/pacman/util/index_arena.h:179:31: warning: format ‘%p’ expects argument of type ‘void*’, but argument 2 has type ‘size_t’ {aka ‘long unsigned int’} [-Wformat=]
  179 |     printf("idx_pool_size_ = %p, is aligned to 2MB = %d\n", idx_pool_size_, (idx_pool_size_ & (2 * 1024 * 1024 - 1)) == 0);
      |                              ~^                             ~~~~~~~~~~~~~~
      |                               |                             |
      |                               void*                         size_t {aka long unsigned int}
      |                              %ld
[100%] Linking CXX executable pacman_bench
[100%] Built target pacman_bench
total keys: 20000000 NUM_OPS_PER_THREAD: 1000000000 NUM_WARMUP_OPS_PER_THREAD: 0
benchmark: ETC
The number of inputs is very large. DBFixture/bench will be repeated at least 320 times.
2024-03-15T14:20:19-05:00
Running ./benchmarks/pacman_bench
Run on (64 X 2000 MHz CPU s)
CPU Caches:
  L1 Data 32 KiB (x32)
  L1 Instruction 64 KiB (x32)
  L2 Unified 512 KiB (x32)
  L3 Unified 8192 KiB (x8)
Load Average: 2.66, 3.92, 4.17
[1710530419]	Setup starts!
[1710530419]	Setup starts!
[1710530419]	Setup starts!
Init capacity utilization 50%  threads of service / gc : 4 / 2
[1710530419]	Setup starts!
Using MADVISE_HUGE
idx_start_addr_ = 0x7f2fba200000, is aligned to 2MB = 1
idx_pool_size_ = 0xa00000000, is aligned to 2MB = 1
DB index type: CCEH
Using MADVISE_HUGE
pool_start_ 0x7f2dbee00000, is aligned to 2M? 1
total_log_size_ 0x1fb000000, is aligned to 2M? 1
[1710530471]	Initializing log segments...
Log: pool_start 0x7f2dbee00000 total segments: 2028  cleaners: 2
[1710530471]Initialized 2026 free log segments...
[1710530471]	DB init finished in 52.293678 seconds
[1710530471]	DB init finished in 52.293563 seconds
[1710530471]	DB init finished in 52.293877 seconds
[1710530471]	DB init finished in 52.293660 seconds
[1710530626]	DB load finished in 155.006589 seconds
[1710530627]	DB load finished in 155.498271 seconds
[1710530628]	DB load finished in 156.499876 seconds
[1710530628]	DB load finished in 156.904593 seconds
[1710530628]	DB warmup finished in 0.000023 seconds
[1710530628]	DB warmup finished in 0.404762 seconds
[1710530628]	DB warmup finished in 1.406384 seconds
[1710530628]	DB warmup finished in 1.898067 seconds
[1710530628]	ETC init!
[1710530628]	ETC starts!
[1710530628]	ETC init!
[1710530628]	ETC starts!
[1710530628]	ETC init!
[1710530628]	ETC init!
[1710530628]	ETC starts!
[1710530628]	ETC starts!
[1710530658]	2000000 OPS in 30.129768 seconds, throughput 66379.535349
[1710530659]	2000000 OPS in 30.926683 seconds, throughput 64669.075568
[1710530660]	2000000 OPS in 31.660946 seconds, throughput 63169.306438
[1710530661]	2000000 OPS in 32.327338 seconds, throughput 61867.141674
[1710530689]	2000000 OPS in 30.633817 seconds, throughput 65287.326095
[1710530689]	2000000 OPS in 30.001125 seconds, throughput 66664.166760
[1710530692]	2000000 OPS in 31.730914 seconds, throughput 63030.015461
[1710530693]	2000000 OPS in 31.908292 seconds, throughput 62679.631990
[1710530732]	2000000 OPS in 43.088693 seconds, throughput 46415.889199
[1710530735]	2000000 OPS in 43.341130 seconds, throughput 46145.543506
[1710530738]	2000000 OPS in 48.893605 seconds, throughput 40905.144957
[1710530741]	2000000 OPS in 48.136964 seconds, throughput 41548.112590
[1710530776]	2000000 OPS in 40.708959 seconds, throughput 49129.234673
[1710530776]	2000000 OPS in 44.014373 seconds, throughput 45439.702163
[1710530783]	2000000 OPS in 45.152557 seconds, throughput 44294.279945
[1710530784]	2000000 OPS in 43.444874 seconds, throughput 46035.350454
[1710530807]	2000000 OPS in 31.030080 seconds, throughput 64453.588260
[1710530807]	2000000 OPS in 30.679111 seconds, throughput 65190.937247
[1710530807]	2000000 OPS in 22.940593 seconds, throughput 87181.704501
[1710530807]	2000000 OPS in 23.931056 seconds, throughput 83573.411888
[1710530808]	2000000 OPS in 1.720613 seconds, throughput 1162376.432120
[1710530809]	2000000 OPS in 1.726266 seconds, throughput 1158570.000220
[1710530809]	2000000 OPS in 1.731551 seconds, throughput 1155033.839604
[1710530809]	2000000 OPS in 1.729311 seconds, throughput 1156529.970607
[1710530810]	2000000 OPS in 1.736027 seconds, throughput 1152055.814800
[1710530810]	2000000 OPS in 1.744934 seconds, throughput 1146175.156195
[1710530811]	2000000 OPS in 1.745512 seconds, throughput 1145795.617561
[1710530811]	2000000 OPS in 1.728963 seconds, throughput 1156762.753165
[1710530812]	2000000 OPS in 1.752481 seconds, throughput 1141239.191752
[1710530812]	2000000 OPS in 1.713854 seconds, throughput 1166960.546231
[1710530812]	2000000 OPS in 1.553075 seconds, throughput 1287767.815463
[1710530812]	2000000 OPS in 1.766830 seconds, throughput 1131970.817792
[1710530814]	2000000 OPS in 1.690779 seconds, throughput 1182886.704886
[1710530814]	2000000 OPS in 1.758606 seconds, throughput 1137264.401463
[1710530814]	2000000 OPS in 1.677095 seconds, throughput 1192538.287932
[1710530814]	2000000 OPS in 1.756533 seconds, throughput 1138606.561903
[1710530815]	2000000 OPS in 1.683330 seconds, throughput 1188121.164596
[1710530815]	2000000 OPS in 1.753376 seconds, throughput 1140656.653222
[1710530816]	2000000 OPS in 1.686195 seconds, throughput 1186102.437737
[1710530816]	2000000 OPS in 1.755285 seconds, throughput 1139416.106216
[1710530817]	2000000 OPS in 1.687263 seconds, throughput 1185351.661241
[1710530817]	2000000 OPS in 1.763954 seconds, throughput 1133816.414714
[1710530817]	2000000 OPS in 1.690832 seconds, throughput 1182849.626693
[1710530818]	2000000 OPS in 1.772541 seconds, throughput 1128323.688987
[1710530819]	2000000 OPS in 1.691516 seconds, throughput 1182371.316618
[1710530819]	2000000 OPS in 1.692644 seconds, throughput 1181583.368978
[1710530819]	2000000 OPS in 1.766745 seconds, throughput 1132025.278124
[1710530819]	2000000 OPS in 1.773238 seconds, throughput 1127880.183032
[1710530820]	2000000 OPS in 1.689363 seconds, throughput 1183878.183670
[1710530821]	2000000 OPS in 1.690456 seconds, throughput 1183112.722248
[1710530821]	2000000 OPS in 1.767334 seconds, throughput 1131648.007677
[1710530821]	2000000 OPS in 1.777092 seconds, throughput 1125434.136218
[1710530822]	2000000 OPS in 1.687834 seconds, throughput 1184950.652730
[1710530822]	2000000 OPS in 1.690260 seconds, throughput 1183249.914214
[1710530823]	2000000 OPS in 1.768829 seconds, throughput 1130691.547911
[1710530823]	2000000 OPS in 1.774473 seconds, throughput 1127095.199532
[1710530824]	2000000 OPS in 1.692254 seconds, throughput 1181855.678876
[1710530824]	2000000 OPS in 1.694329 seconds, throughput 1180408.291424
[1710530824]	2000000 OPS in 1.745571 seconds, throughput 1145756.889866
[1710530825]	2000000 OPS in 1.751144 seconds, throughput 1142110.528889
[1710530826]	2000000 OPS in 1.694018 seconds, throughput 1180624.999262
[1710530826]	2000000 OPS in 1.692499 seconds, throughput 1181684.597746
[1710530826]	2000000 OPS in 1.754147 seconds, throughput 1140155.300553
[1710530826]	2000000 OPS in 1.755138 seconds, throughput 1139511.536985
[1710530827]	2000000 OPS in 1.695189 seconds, throughput 1179809.448976
[1710530827]	2000000 OPS in 1.696997 seconds, throughput 1178552.466504
[1710530828]	2000000 OPS in 1.762414 seconds, throughput 1134807.145200
[1710530828]	2000000 OPS in 1.773254 seconds, throughput 1127870.006215
[1710530829]	2000000 OPS in 1.699736 seconds, throughput 1176653.315574
[1710530829]	2000000 OPS in 1.697529 seconds, throughput 1178183.112041
[1710530830]	2000000 OPS in 1.779209 seconds, throughput 1124095.033242
[1710530830]	2000000 OPS in 1.783303 seconds, throughput 1121514.403329
[1710530831]	2000000 OPS in 1.699713 seconds, throughput 1176669.237689
[1710530831]	2000000 OPS in 1.700019 seconds, throughput 1176457.439593
[1710530831]	2000000 OPS in 1.785802 seconds, throughput 1119944.988302
[1710530832]	2000000 OPS in 1.782198 seconds, throughput 1122209.765694
[1710530832]	2000000 OPS in 1.700260 seconds, throughput 1176290.684954
[1710530832]	2000000 OPS in 1.702780 seconds, throughput 1174549.853769
[1710530833]	2000000 OPS in 1.787308 seconds, throughput 1119001.313708
[1710530834]	2000000 OPS in 1.788921 seconds, throughput 1117992.354050
[1710530834]	2000000 OPS in 1.703326 seconds, throughput 1174173.352605
[1710530834]	2000000 OPS in 1.703239 seconds, throughput 1174233.328382
[1710530835]	2000000 OPS in 1.789213 seconds, throughput 1117809.897424
[1710530835]	2000000 OPS in 1.789262 seconds, throughput 1117779.285538
[1710530836]	2000000 OPS in 1.708034 seconds, throughput 1170936.878306
[1710530836]	2000000 OPS in 1.718986 seconds, throughput 1163476.607721
[1710530837]	2000000 OPS in 1.794165 seconds, throughput 1114724.676939
[1710530837]	2000000 OPS in 1.790884 seconds, throughput 1116766.915110
[1710530837]	2000000 OPS in 1.773188 seconds, throughput 1127911.986772
[1710530838]	2000000 OPS in 1.766472 seconds, throughput 1132200.227346
[1710530839]	2000000 OPS in 1.792086 seconds, throughput 1116017.869678
[1710530839]	2000000 OPS in 1.796492 seconds, throughput 1113280.771637
[1710530839]	2000000 OPS in 1.776339 seconds, throughput 1125911.214019
[1710530839]	2000000 OPS in 1.764310 seconds, throughput 1133587.634826
[1710530840]	2000000 OPS in 1.795524 seco./benchmarks/pacman_bench: Segmentation fault

 Performance counter stats for './benchmarks/pacman_bench --benchmark_repetitions=1 --benchmark_filter=/(50)/.*/threads:(4)$ --benchmark_out=../results/etc_2_1 --benchmark_out_format=json':

     3,221,380,607      ls_l1_d_tlb_miss.all                                          (33.38%)
                 0      ls_l1_d_tlb_miss.tlb_reload_1g_l2_hit                                     (33.43%)
        18,586,048      ls_l1_d_tlb_miss.tlb_reload_1g_l2_miss                                     (33.43%)
       263,444,328      ls_l1_d_tlb_miss.tlb_reload_2m_l2_hit                                     (33.40%)
        26,365,816      ls_l1_d_tlb_miss.tlb_reload_2m_l2_miss                                     (33.51%)
       302,980,749      ls_l1_d_tlb_miss.tlb_reload_32k_l2_hit                                     (33.28%)
       516,228,575      ls_l1_d_tlb_miss.tlb_reload_32k_l2_miss                                     (33.18%)
     1,347,848,324      ls_l1_d_tlb_miss.tlb_reload_4k_l2_hit                                     (33.24%)
       756,988,001      ls_l1_d_tlb_miss.tlb_reload_4k_l2_miss                                     (33.27%)
   896,954,137,796      instructions              #    0.52  insn per cycle           (33.27%)
   267,883,440,219      instructions:u                                                (33.35%)
   629,108,030,437      instructions:k                                                (33.39%)
         2,724,103      page-faults                                                 
         2,723,991      minor-faults                                                
               111      major-faults                                                
         2,613,190      xfs:xfs_filemap_fault                                       
 1,741,261,320,028      cycles                                                        (33.34%)
        19,900,776      context-switches                                            
             5,378      cpu-migrations                                              
   180,931,953,061      branches                                                      (33.34%)
    15,983,224,662      branch-misses             #    8.83% of all branches          (33.23%)
                 0      filemap:mm_filemap_delete_from_page_cache                                   
               512      filemap:mm_filemap_add_to_page_cache                                   
                 0      filemap:filemap_set_wb_err                                   
                 0      filemap:file_check_and_advance_wb_err                                   
                 0      fs_dax:dax_pmd_fault                                        
                 0      fs_dax:dax_pmd_fault_done                                   
                 0      fs_dax:dax_pmd_load_hole                                    
                 0      fs_dax:dax_pmd_load_hole_fallback                                   
                 0      fs_dax:dax_pmd_insert_mapping                                   
         2,603,009      fs_dax:dax_pte_fault                                        
         2,603,009      fs_dax:dax_pte_fault_done                                   
                 0      fs_dax:dax_load_hole                                        
                 0      fs_dax:dax_insert_pfn_mkwrite_no_entry                                   
         2,603,009      fs_dax:dax_insert_pfn_mkwrite                                   
                 0      fs_dax:dax_insert_mapping                                   
         2,603,007      fs_dax:dax_writeback_range                                   
         2,603,007      fs_dax:dax_writeback_range_done                                   
                 0      fs_dax:dax_writeback_one                                    

     440.477074520 seconds time elapsed

     247.037247000 seconds user
     625.735485000 seconds sys


268.29user 632.42system 7:38.15elapsed 196%CPU (0avgtext+0avgdata 251904maxresident)k
320048inputs+33736outputs (1659major+3769529minor)pagefaults 0swaps
